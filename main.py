import asyncio
import logging
import os
import sqlite3
from datetime import datetime, timedelta
from typing import Optional, Dict, Any

from aiogram import Bot, Dispatcher, Router, F
from aiogram.types import (
    Message, ReplyKeyboardMarkup, KeyboardButton,
    ReplyKeyboardRemove
)
from aiogram.filters import Command, CommandStart
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.context import FSMContext
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.enums import ParseMode
from aiogram.client.default import DefaultBotProperties

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# âš™ï¸  ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ Ğ›ĞĞ“Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ¯
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.StreamHandler(),
        logging.FileHandler('bot.log', encoding='utf-8')
    ]
)
logger = logging.getLogger(__name__)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ” Ğ—ĞĞ“Ğ Ğ£Ğ—ĞšĞ ĞŸĞ•Ğ Ğ•ĞœĞ•ĞĞĞ«Ğ¥ ĞĞšĞ Ğ£Ğ–Ğ•ĞĞ˜Ğ¯
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Ğ”Ğ»Ñ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ python-dotenv
try:
    from dotenv import load_dotenv
    load_dotenv()
    logger.info(".env Ñ„Ğ°Ğ¹Ğ» Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½ Ğ´Ğ»Ñ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸")
except ImportError:
    logger.info("python-dotenv Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹")

# ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾ĞºĞµĞ½Ğ° Ğ¸Ğ· Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
BOT_TOKEN = os.getenv("BOT_TOKEN")

if not BOT_TOKEN:
    logger.error("BOT_TOKEN Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ!")
    logger.info("ĞĞ° Railway Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½ÑƒÑ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ BOT_TOKEN")
    logger.info("Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾: ÑĞ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ .env Ñ„Ğ°Ğ¹Ğ» Ñ BOT_TOKEN=Ğ²Ğ°Ñˆ_Ñ‚Ğ¾ĞºĞµĞ½")
    exit(1)

logger.info("Ğ‘Ğ¾Ñ‚ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½, Ñ‚Ğ¾ĞºĞµĞ½ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½")

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ¤– Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ Ğ‘ĞĞ¢Ğ Ğ˜ Ğ”Ğ˜Ğ¡ĞŸĞ•Ğ¢Ğ§Ğ•Ğ Ğ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

bot = Bot(
    token=BOT_TOKEN,
    default=DefaultBotProperties(parse_mode=ParseMode.HTML)
)

# Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ MemoryStorage Ğ´Ğ»Ñ Railway
storage = MemoryStorage()
dp = Dispatcher(storage=storage)
router = Router()
dp.include_router(router)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ’¾ ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ Ğ‘ĞĞ—Ğ« Ğ”ĞĞĞĞ«Ğ¥
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def get_db_connection():
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğº SQLite Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…"""
    conn = sqlite3.connect('waybills.db', check_same_thread=False)
    conn.row_factory = sqlite3.Row
    return conn

def init_database():
    """Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ğµ"""
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ĞµĞ¹
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS vehicles (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                number TEXT UNIQUE NOT NULL,
                fuel_rate REAL NOT NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ¿ÑƒÑ‚ĞµĞ²Ñ‹Ñ… Ğ»Ğ¸ÑÑ‚Ğ¾Ğ²
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS waybills (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                vehicle_id INTEGER NOT NULL,
                user_id INTEGER NOT NULL,
                date TEXT NOT NULL,
                start_time TEXT,
                end_time TEXT,
                total_hours REAL,
                odo_start REAL,
                odo_end REAL,
                distance REAL,
                fuel_start REAL,
                fuel_end REAL,
                fuel_norm REAL,
                fuel_actual REAL,
                overuse REAL DEFAULT 0,
                economy REAL DEFAULT 0,
                fuel_rate REAL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (vehicle_id) REFERENCES vehicles (id)
            )
        ''')
        
        # Ğ˜Ğ½Ğ´ĞµĞºÑÑ‹ Ğ´Ğ»Ñ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸
        cursor.execute('CREATE INDEX IF NOT EXISTS idx_waybills_user_date ON waybills(user_id, date)')
        cursor.execute('CREATE INDEX IF NOT EXISTS idx_waybills_vehicle_date ON waybills(vehicle_id, date)')
        
        conn.commit()
        conn.close()
        logger.info("Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°")
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ‘Ğ”: {e}")

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“Š ĞšĞ›ĞĞ¡Ğ¡ Ğ”Ğ›Ğ¯ Ğ ĞĞ‘ĞĞ¢Ğ« Ğ¡ Ğ‘ĞĞ—ĞĞ™ Ğ”ĞĞĞĞ«Ğ¥
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class Database:
    @staticmethod
    def add_vehicle(number: str, fuel_rate: float) -> Optional[int]:
        """Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»Ñ"""
        try:
            conn = get_db_connection()
            cursor = conn.cursor()
            cursor.execute(
                "INSERT INTO vehicles (number, fuel_rate) VALUES (?, ?)",
                (number.upper(), fuel_rate)
            )
            conn.commit()
            vehicle_id = cursor.lastrowid
            conn.close()
            logger.info(f"Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ {number}")
            return vehicle_id
        except sqlite3.IntegrityError:
            logger.warning(f"ĞĞ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ {number} ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚")
            return None
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»Ñ: {e}")
            return None
    
    @staticmethod
    def get_vehicles() -> list:
        """ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ ÑĞ¿Ğ¸ÑĞºĞ° Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ĞµĞ¹"""
        try:
            conn = get_db_connection()
            cursor = conn.cursor()
            cursor.execute("SELECT id, number, fuel_rate FROM vehicles ORDER BY number")
            vehicles = cursor.fetchall()
            conn.close()
            return vehicles
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑĞ¿Ğ¸ÑĞºĞ° Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ĞµĞ¹: {e}")
            return []
    
    @staticmethod
    def get_vehicle(vehicle_id: int):
        """ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾Ğ± Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»Ğµ"""
        try:
            conn = get_db_connection()
            cursor = conn.cursor()
            cursor.execute("SELECT id, number, fuel_rate FROM vehicles WHERE id = ?", (vehicle_id,))
            vehicle = cursor.fetchone()
            conn.close()
            return vehicle
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»Ñ: {e}")
            return None
    
    @staticmethod
    def get_last_waybill(vehicle_id: int, user_id: int):
        """ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ Ğ¿ÑƒÑ‚ĞµĞ²Ğ¾Ğ³Ğ¾ Ğ»Ğ¸ÑÑ‚Ğ°"""
        try:
            conn = get_db_connection()
            cursor = conn.cursor()
            cursor.execute('''
                SELECT odo_end, fuel_end, date 
                FROM waybills 
                WHERE vehicle_id = ? AND user_id = ?
                ORDER BY date DESC, id DESC 
                LIMIT 1
            ''', (vehicle_id, user_id))
            waybill = cursor.fetchone()
            conn.close()
            return waybill
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ Ğ¿ÑƒÑ‚ĞµĞ²Ğ¾Ğ³Ğ¾ Ğ»Ğ¸ÑÑ‚Ğ°: {e}")
            return None
    
    @staticmethod
    def save_waybill(data: Dict[str, Any]) -> Optional[int]:
        """Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ¿ÑƒÑ‚ĞµĞ²Ğ¾Ğ³Ğ¾ Ğ»Ğ¸ÑÑ‚Ğ°"""
        try:
            conn = get_db_connection()
            cursor = conn.cursor()
            cursor.execute('''
                INSERT INTO waybills 
                (vehicle_id, user_id, date, start_time, end_time, total_hours, 
                 odo_start, odo_end, distance, fuel_start, fuel_end, 
                 fuel_norm, fuel_actual, overuse, economy, fuel_rate)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', (
                data['vehicle_id'],
                data['user_id'],
                data.get('date', datetime.now().strftime('%Y-%m-%d')),
                data.get('start_time'),
                data.get('end_time'),
                data.get('hours'),
                data.get('odo_start'),
                data.get('odo_end'),
                data.get('distance'),
                data.get('fuel_start'),
                data.get('fuel_end'),
                data.get('fuel_norm'),
                data.get('fuel_actual'),
                data.get('overuse', 0),
                data.get('economy', 0),
                data.get('fuel_rate')
            ))
            conn.commit()
            waybill_id = cursor.lastrowid
            conn.close()
            logger.info(f"Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½ Ğ¿ÑƒÑ‚ĞµĞ²Ğ¾Ğ¹ Ğ»Ğ¸ÑÑ‚ #{waybill_id}")
            return waybill_id
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ¿ÑƒÑ‚ĞµĞ²Ğ¾Ğ³Ğ¾ Ğ»Ğ¸ÑÑ‚Ğ°: {e}")
            return None
    
    @staticmethod
    def get_statistics(vehicle_id: int, user_id: int, days: int = 7):
        """ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸"""
        try:
            conn = get_db_connection()
            cursor = conn.cursor()
            cursor.execute('''
                SELECT 
                    COUNT(*) as trips,
                    SUM(distance) as total_distance,
                    SUM(fuel_actual) as total_fuel,
                    AVG(fuel_actual/distance*100) as avg_consumption
                FROM waybills 
                WHERE vehicle_id = ? AND user_id = ? 
                AND date >= date('now', '-' || ? || ' days')
            ''', (vehicle_id, user_id, days))
            stats = cursor.fetchone()
            conn.close()
            return stats
        except Exception as e:
            logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸: {e}")
            return None

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“ Ğ¡ĞĞ¡Ğ¢ĞĞ¯ĞĞ˜Ğ¯ FSM
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class AddVehicleStates(StatesGroup):
    number = State()
    fuel_rate = State()

class WaybillStates(StatesGroup):
    vehicle_selected = State()
    start_time = State()
    odo_start = State()
    fuel_start = State()
    end_time = State()
    odo_end = State()
    overuse = State()
    economy = State()

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# âŒ¨ï¸  ĞšĞ›ĞĞ’Ğ˜ĞĞ¢Ğ£Ğ Ğ«
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def get_main_keyboard() -> ReplyKeyboardMarkup:
    """ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ°"""
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="ğŸ“ ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¿ÑƒÑ‚ĞµĞ²Ğ¾Ğ¹ Ğ»Ğ¸ÑÑ‚")],
            [KeyboardButton(text="ğŸš— Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ")],
            [KeyboardButton(text="ğŸ“Š ĞœĞ¾Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»Ğ¸")],
            [KeyboardButton(text="ğŸ“ˆ Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°")]
        ],
        resize_keyboard=True,
        input_field_placeholder="Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ..."
    )

def get_skip_keyboard() -> ReplyKeyboardMarkup:
    """ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°"""
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="0")],
            [KeyboardButton(text="â­ ĞŸÑ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ")]
        ],
        resize_keyboard=True
    )

def get_vehicles_keyboard(vehicles: list) -> ReplyKeyboardMarkup:
    """ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»Ñ"""
    buttons = []
    for vehicle in vehicles:
        buttons.append([KeyboardButton(text=f"ğŸš™ {vehicle['number']} ({vehicle['fuel_rate']} Ğ»/ĞºĞ¼)")])
    buttons.append([KeyboardButton(text="âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°")])
    return ReplyKeyboardMarkup(keyboard=buttons, resize_keyboard=True)

def get_confirm_keyboard(odo_value: float, fuel_value: float) -> ReplyKeyboardMarkup:
    """ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…"""
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text=f"âœ… ĞĞ´Ğ¾Ğ¼ĞµÑ‚Ñ€: {odo_value:.0f} ĞºĞ¼")],
            [KeyboardButton(text=f"âœ… Ğ¢Ğ¾Ğ¿Ğ»Ğ¸Ğ²Ğ¾: {fuel_value:.2f} Ğ»")],
            [KeyboardButton(text="âœï¸ Ğ’Ğ²ĞµÑÑ‚Ğ¸ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ")]
        ],
        resize_keyboard=True
    )

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ› ï¸  Ğ’Ğ¡ĞŸĞĞœĞĞ“ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ«Ğ• Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def calculate_hours(start_time: str, end_time: str) -> float:
    """Ğ Ğ°ÑÑ‡ĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° Ñ‡Ğ°ÑĞ¾Ğ² Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ´Ğ²ÑƒĞ¼Ñ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ°Ğ¼Ğ¸"""
    try:
        fmt = "%H:%M"
        start = datetime.strptime(start_time, fmt)
        end = datetime.strptime(end_time, fmt)
        
        if end < start:
            end += timedelta(days=1)
        
        hours = (end - start).total_seconds() / 3600
        return round(hours, 2)
    except Exception as e:
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ° Ñ‡Ğ°ÑĞ¾Ğ²: {e}")
        return 0.0

def validate_time(time_str: str) -> bool:
    """Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ° Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸"""
    try:
        datetime.strptime(time_str, "%H:%M")
        return True
    except ValueError:
        return False

def validate_number(value: str) -> bool:
    """Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ñ‡Ğ¸ÑĞ»Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ"""
    try:
        float(value)
        return True
    except ValueError:
        return False

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ  ĞĞ‘Ğ ĞĞ‘ĞĞ¢Ğ§Ğ˜ĞšĞ˜ ĞšĞĞœĞĞĞ”
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.message(CommandStart())
async def cmd_start(message: Message, state: FSMContext):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /start"""
    await state.clear()
    logger.info(f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {message.from_user.id} Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ğ» Ğ±Ğ¾Ñ‚Ğ°")
    
    await message.answer(
        "<b>ğŸš› Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° ÑƒÑ‡ĞµÑ‚Ğ° Ğ¿ÑƒÑ‚ĞµĞ²Ñ‹Ñ… Ğ»Ğ¸ÑÑ‚Ğ¾Ğ²</b>\n\n"
        "Ğ‘Ğ¾Ñ‚ Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°ĞµÑ‚ Ğ²ĞµÑÑ‚Ğ¸ ÑƒÑ‡ĞµÑ‚ Ğ¿ÑƒÑ‚ĞµĞ²Ñ‹Ñ… Ğ»Ğ¸ÑÑ‚Ğ¾Ğ², "
        "ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ€Ğ°ÑÑ…Ğ¾Ğ´ Ñ‚Ğ¾Ğ¿Ğ»Ğ¸Ğ²Ğ° Ğ¸ Ğ¿Ñ€Ğ¾Ğ±ĞµĞ³.\n\n"
        "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:",
        reply_markup=get_main_keyboard()
    )

@router.message(Command("help"))
async def cmd_help(message: Message):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /help"""
    help_text = """
<b>ğŸ“‹ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:</b>

/start - Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ
/help - Ğ­Ñ‚Ğ° ÑĞ¿Ñ€Ğ°Ğ²ĞºĞ°
/cancel - ĞÑ‚Ğ¼ĞµĞ½Ğ° Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ

<b>ğŸ“ ĞšĞ°Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ñ Ğ±Ğ¾Ñ‚Ğ¾Ğ¼:</b>

1. <b>Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ</b> - ÑƒĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ³Ğ¾Ñ. Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ¸ Ğ½Ğ¾Ñ€Ğ¼Ñƒ Ñ€Ğ°ÑÑ…Ğ¾Ğ´Ğ°
2. <b>Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ¿ÑƒÑ‚ĞµĞ²Ğ¾Ğ¹ Ğ»Ğ¸ÑÑ‚</b> - Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ° Ğ´ĞµĞ½ÑŒ
3. <b>Ğ‘Ğ¾Ñ‚ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ñ€Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°ĞµÑ‚:</b>
   â€¢ ĞŸÑ€Ğ¾Ğ±ĞµĞ³ Ğ·Ğ° Ğ´ĞµĞ½ÑŒ
   â€¢ Ğ Ğ°ÑÑ…Ğ¾Ğ´ Ğ¿Ğ¾ Ğ½Ğ¾Ñ€Ğ¼Ğµ Ğ¸ Ñ„Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹
   â€¢ ĞÑÑ‚Ğ°Ñ‚Ğ¾Ğº Ñ‚Ğ¾Ğ¿Ğ»Ğ¸Ğ²Ğ°
4. <b>Ğ¡Ğ¼Ğ¾Ñ‚Ñ€Ğ¸Ñ‚Ğµ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ</b> Ğ·Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 7 Ğ´Ğ½ĞµĞ¹

<b>âš ï¸ Ğ’Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ:</b>
â€¢ Ğ’Ñ€ĞµĞ¼Ñ ÑƒĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ğ¹Ñ‚Ğµ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ Ğ§Ğ§:ĞœĞœ
â€¢ ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ñ Ğ¾Ğ´Ğ¾Ğ¼ĞµÑ‚Ñ€Ğ° - Ğ² ĞºĞ¸Ğ»Ğ¾Ğ¼ĞµÑ‚Ñ€Ğ°Ñ…
â€¢ Ğ¢Ğ¾Ğ¿Ğ»Ğ¸Ğ²Ğ¾ - Ğ² Ğ»Ğ¸Ñ‚Ñ€Ğ°Ñ…
"""
    await message.answer(help_text)

@router.message(Command("cancel"))
@router.message(F.text == "âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°")
async def cmd_cancel(message: Message, state: FSMContext):
    """ĞÑ‚Ğ¼ĞµĞ½Ğ° Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ"""
    current_state = await state.get_state()
    if current_state is None:
        await message.answer("ğŸ¤· ĞĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½Ñ‹", reply_markup=get_main_keyboard())
        return
    
    await state.clear()
    logger.info(f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {message.from_user.id} Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ğ» Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ")
    await message.answer("âœ… Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ¾", reply_markup=get_main_keyboard())

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸš— Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• ĞĞ’Ğ¢ĞĞœĞĞ‘Ğ˜Ğ›Ğ¯
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.message(F.text == "ğŸš— Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ")
async def add_vehicle_start(message: Message, state: FSMContext):
    """ĞĞ°Ñ‡Ğ°Ğ»Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»Ñ"""
    await message.answer(
        "ğŸš— Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ³Ğ¾ÑÑƒĞ´Ğ°Ñ€ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»Ñ:",
        reply_markup=ReplyKeyboardRemove()
    )
    await state.set_state(AddVehicleStates.number)
    logger.info(f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {message.from_user.id} Ğ½Ğ°Ñ‡Ğ°Ğ» Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»Ñ")

@router.message(AddVehicleStates.number)
async def add_vehicle_number(message: Message, state: FSMContext):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ½Ğ¾Ğ¼ĞµÑ€Ğ° Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»Ñ"""
    number = message.text.strip().upper()
    if len(number) < 3:
        await message.answer("âŒ ĞĞ¾Ğ¼ĞµÑ€ ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğ¹. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ĞµÑ‰Ğµ Ñ€Ğ°Ğ·:")
        return
    
    await state.update_data(number=number)
    await message.answer("â›½ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ñ€Ğ¼Ñƒ Ñ€Ğ°ÑÑ…Ğ¾Ğ´Ğ° Ñ‚Ğ¾Ğ¿Ğ»Ğ¸Ğ²Ğ° (Ğ»/ĞºĞ¼):\nĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: <code>0.12</code>")
    await state.set_state(AddVehicleStates.fuel_rate)

@router.message(AddVehicleStates.fuel_rate)
async def add_vehicle_fuel_rate(message: Message, state: FSMContext):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ½Ğ¾Ñ€Ğ¼Ñ‹ Ñ€Ğ°ÑÑ…Ğ¾Ğ´Ğ°"""
    if not validate_number(message.text):
        await message.answer("âŒ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: <code>0.12</code>):")
        return
    
    fuel_rate = float(message.text.strip())
    if fuel_rate <= 0 or fuel_rate > 5:
        await message.answer("âŒ ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ°Ñ Ğ½Ğ¾Ñ€Ğ¼Ğ° Ñ€Ğ°ÑÑ…Ğ¾Ğ´Ğ°. Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚ 0.01 Ğ´Ğ¾ 5:")
        return
    
    data = await state.get_data()
    vehicle_id = Database.add_vehicle(data['number'], fuel_rate)
    
    if vehicle_id:
        await message.answer(
            f"âœ… ĞĞ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ <b>{data['number']}</b> Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½!\n"
            f"â›½ ĞĞ¾Ñ€Ğ¼Ğ° Ñ€Ğ°ÑÑ…Ğ¾Ğ´Ğ°: {fuel_rate} Ğ»/ĞºĞ¼",
            reply_markup=get_main_keyboard()
        )
    else:
        await message.answer(
            f"âŒ ĞĞ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ {data['number']} ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚!",
            reply_markup=get_main_keyboard()
        )
    
    await state.clear()

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“Š Ğ¡ĞŸĞ˜Ğ¡ĞĞš ĞĞ’Ğ¢ĞĞœĞĞ‘Ğ˜Ğ›Ğ•Ğ™
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.message(F.text == "ğŸ“Š ĞœĞ¾Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»Ğ¸")
async def list_vehicles(message: Message):
    """Ğ’Ñ‹Ğ²Ğ¾Ğ´ ÑĞ¿Ğ¸ÑĞºĞ° Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ĞµĞ¹"""
    vehicles = Database.get_vehicles()
    
    if not vehicles:
        await message.answer(
            "âŒ Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ĞµĞ¹.\n"
            "Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ!",
            reply_markup=get_main_keyboard()
        )
        return
    
    text = "<b>ğŸš— Ğ¡ĞŸĞ˜Ğ¡ĞĞš ĞĞ’Ğ¢ĞĞœĞĞ‘Ğ˜Ğ›Ğ•Ğ™</b>\n" + "â”" * 30 + "\n\n"
    for vehicle in vehicles:
        text += f"ğŸš™ <b>{vehicle['number']}</b>\nâ›½ Ğ Ğ°ÑÑ…Ğ¾Ğ´: {vehicle['fuel_rate']} Ğ»/ĞºĞ¼\n\n"
    
    await message.answer(text)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“ˆ Ğ¡Ğ¢ĞĞ¢Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.message(F.text == "ğŸ“ˆ Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°")
async def show_statistics(message: Message, state: FSMContext):
    """ĞŸĞ¾ĞºĞ°Ğ· ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸"""
    vehicles = Database.get_vehicles()
    
    if not vehicles:
        await message.answer(
            "âŒ ĞĞµÑ‚ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ĞµĞ¹ Ğ´Ğ»Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸",
            reply_markup=get_main_keyboard()
        )
        return
    
    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ĞµĞ¹ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ°
    await state.update_data(vehicles=vehicles, action='stats')
    
    await message.answer(
        "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸:",
        reply_markup=get_vehicles_keyboard(vehicles)
    )

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“ ĞĞĞ’Ğ«Ğ™ ĞŸĞ£Ğ¢Ğ•Ğ’ĞĞ™ Ğ›Ğ˜Ğ¡Ğ¢
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.message(F.text == "ğŸ“ ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¿ÑƒÑ‚ĞµĞ²Ğ¾Ğ¹ Ğ»Ğ¸ÑÑ‚")
async def new_waybill(message: Message, state: FSMContext):
    """ĞĞ°Ñ‡Ğ°Ğ»Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ¿ÑƒÑ‚ĞµĞ²Ğ¾Ğ³Ğ¾ Ğ»Ğ¸ÑÑ‚Ğ°"""
    vehicles = Database.get_vehicles()
    
    if not vehicles:
        await message.answer(
            "âŒ Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ!",
            reply_markup=get_main_keyboard()
        )
        return
    
    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ĞµĞ¹ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ°
    await state.update_data(vehicles=vehicles, action='waybill')
    
    await message.answer(
        "ğŸš— Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ Ğ´Ğ»Ñ Ğ¿ÑƒÑ‚ĞµĞ²Ğ¾Ğ³Ğ¾ Ğ»Ğ¸ÑÑ‚Ğ°:",
        reply_markup=get_vehicles_keyboard(vehicles)
    )
    logger.info(f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {message.from_user.id} Ğ½Ğ°Ñ‡Ğ°Ğ» Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿ÑƒÑ‚ĞµĞ²Ğ¾Ğ¹ Ğ»Ğ¸ÑÑ‚")

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸš™ Ğ’Ğ«Ğ‘ĞĞ  ĞĞ’Ğ¢ĞĞœĞĞ‘Ğ˜Ğ›Ğ¯
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.message(F.text.startswith("ğŸš™ "))
async def vehicle_selected(message: Message, state: FSMContext):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»Ñ"""
    data = await state.get_data()
    action = data.get('action')
    vehicles = data.get('vehicles', [])
    
    # Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ¸Ğ· Ñ‚ĞµĞºÑÑ‚Ğ° ĞºĞ½Ğ¾Ğ¿ĞºĞ¸
    try:
        vehicle_text = message.text[2:]  # Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸
        vehicle_number = vehicle_text.split(" (")[0]
    except:
        await message.answer("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ°. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ÑĞ½Ğ¾Ğ²Ğ°.", reply_markup=get_main_keyboard())
        await state.clear()
        return
    
    # ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ Ğ² ÑĞ¿Ğ¸ÑĞºĞµ
    vehicle = None
    for v in vehicles:
        if v['number'] == vehicle_number:
            vehicle = v
            break
    
    if not vehicle:
        await message.answer("âŒ ĞĞ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½", reply_markup=get_main_keyboard())
        await state.clear()
        return
    
    user_id = message.from_user.id
    
    if action == 'stats':
        # ĞŸĞ¾ĞºĞ°Ğ· ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸
        stats = Database.get_statistics(vehicle['id'], user_id, 7)
        
        if not stats or stats['trips'] == 0:
            await message.answer(
                f"<b>ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°: {vehicle['number']}</b>\n\n"
                f"ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ·Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 7 Ğ´Ğ½ĞµĞ¹",
                reply_markup=get_main_keyboard()
            )
        else:
            avg_consumption = stats['avg_consumption'] if stats['avg_consumption'] else 0
            await message.answer(
                f"<b>ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°: {vehicle['number']}</b>\n"
                f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
                f"<b>ğŸ“… Ğ—Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 7 Ğ´Ğ½ĞµĞ¹:</b>\n"
                f"ğŸš— ĞŸĞ¾ĞµĞ·Ğ´Ğ¾Ğº: {stats['trips']}\n"
                f"ğŸ“ ĞŸÑ€Ğ¾Ğ±ĞµĞ³: {stats['total_distance']:.0f} ĞºĞ¼\n"
                f"â›½ Ğ¢Ğ¾Ğ¿Ğ»Ğ¸Ğ²Ğ°: {stats['total_fuel']:.2f} Ğ»\n"
                f"ğŸ“Š Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ñ€Ğ°ÑÑ…Ğ¾Ğ´: {avg_consumption:.2f} Ğ»/100ĞºĞ¼",
                reply_markup=get_main_keyboard()
            )
        await state.clear()
    else:
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿ÑƒÑ‚ĞµĞ²Ğ¾Ğ³Ğ¾ Ğ»Ğ¸ÑÑ‚Ğ°
        await state.update_data(
            vehicle_id=vehicle['id'],
            vehicle_number=vehicle['number'],
            fuel_rate=vehicle['fuel_rate'],
            user_id=user_id
        )
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ¿ÑƒÑ‚ĞµĞ²Ğ¾Ğ¹ Ğ»Ğ¸ÑÑ‚
        last_waybill = Database.get_last_waybill(vehicle['id'], user_id)
        
        if last_waybill:
            await state.update_data(
                suggested_odo=last_waybill['odo_end'],
                suggested_fuel=last_waybill['fuel_end']
            )
            await message.answer(
                f"ğŸš— ĞĞ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ: <b>{vehicle['number']}</b>\n\n"
                f"ğŸ“… ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ¿ÑƒÑ‚ĞµĞ²Ğ¾Ğ¹ Ğ»Ğ¸ÑÑ‚: {last_waybill['date']}\n"
                f"ğŸ›£ ĞĞ´Ğ¾Ğ¼ĞµÑ‚Ñ€: {last_waybill['odo_end']:.0f} ĞºĞ¼\n"
                f"â›½ ĞÑÑ‚Ğ°Ñ‚Ğ¾Ğº Ñ‚Ğ¾Ğ¿Ğ»Ğ¸Ğ²Ğ°: {last_waybill['fuel_end']:.2f} Ğ»\n\n"
                f"Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑ‚Ğ¸ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ?",
                reply_markup=get_confirm_keyboard(last_waybill['odo_end'], last_waybill['fuel_end'])
            )
            await state.set_state(WaybillStates.vehicle_selected)
        else:
            await message.answer(
                f"ğŸš— ĞĞ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ: <b>{vehicle['number']}</b>\n\n"
                f"ğŸ•’ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ñ€ĞµĞ¼Ñ Ğ²Ñ‹Ğ¿ÑƒÑĞºĞ° Ğ½Ğ° Ğ»Ğ¸Ğ½Ğ¸Ñ (Ğ§Ğ§:ĞœĞœ):",
                reply_markup=ReplyKeyboardRemove()
            )
            await state.set_state(WaybillStates.start_time)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“ ĞŸĞ ĞĞ¦Ğ•Ğ¡Ğ¡ Ğ—ĞĞŸĞĞ›ĞĞ•ĞĞ˜Ğ¯ ĞŸĞ£Ğ¢Ğ•Ğ’ĞĞ“Ğ Ğ›Ğ˜Ğ¡Ğ¢Ğ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.message(WaybillStates.vehicle_selected)
async def handle_previous_data(message: Message, state: FSMContext):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…"""
    data = await state.get_data()
    
    if message.text.startswith("âœ… ĞĞ´Ğ¾Ğ¼ĞµÑ‚Ñ€"):
        await state.update_data(odo_start=data['suggested_odo'])
        await message.answer(
            f"âœ… ĞĞ´Ğ¾Ğ¼ĞµÑ‚Ñ€: {data['suggested_odo']:.0f} ĞºĞ¼\n\n"
            f"â›½ ĞÑÑ‚Ğ°Ñ‚Ğ¾Ğº Ñ‚Ğ¾Ğ¿Ğ»Ğ¸Ğ²Ğ° Ğ¿Ñ€Ğ¸ Ğ²Ñ‹ĞµĞ·Ğ´Ğµ:",
            reply_markup=ReplyKeyboardRemove()
        )
        await state.set_state(WaybillStates.fuel_start)
    elif message.text.startswith("âœ… Ğ¢Ğ¾Ğ¿Ğ»Ğ¸Ğ²Ğ¾"):
        await state.update_data(fuel_start=data['suggested_fuel'])
        await message.answer(
            f"âœ… Ğ¢Ğ¾Ğ¿Ğ»Ğ¸Ğ²Ğ¾: {data['suggested_fuel']:.2f} Ğ»\n\n"
            f"ğŸ›£ ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ñ Ğ¾Ğ´Ğ¾Ğ¼ĞµÑ‚Ñ€Ğ° Ğ½Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾ Ğ´Ğ½Ñ:",
            reply_markup=ReplyKeyboardRemove()
        )
        await state.set_state(WaybillStates.odo_start)
    else:
        await message.answer(
            "ğŸ•’ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ñ€ĞµĞ¼Ñ Ğ²Ñ‹Ğ¿ÑƒÑĞºĞ° Ğ½Ğ° Ğ»Ğ¸Ğ½Ğ¸Ñ (Ğ§Ğ§:ĞœĞœ):",
            reply_markup=ReplyKeyboardRemove()
        )
        await state.set_state(WaybillStates.start_time)

@router.message(WaybillStates.start_time)
async def start_time_input(message: Message, state: FSMContext):
    """Ğ’Ğ²Ğ¾Ğ´ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ°"""
    if not validate_time(message.text):
        await message.answer("âŒ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚! Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ñ€ĞµĞ¼Ñ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ Ğ§Ğ§:ĞœĞœ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: <code>08:30</code>)")
        return
    
    await state.update_data(start_time=message.text)
    await message.answer("ğŸ›£ ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ñ Ğ¾Ğ´Ğ¾Ğ¼ĞµÑ‚Ñ€Ğ° Ğ½Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾ Ğ´Ğ½Ñ:")
    await state.set_state(WaybillStates.odo_start)

@router.message(WaybillStates.odo_start)
async def odo_start_input(message: Message, state: FSMContext):
    """Ğ’Ğ²Ğ¾Ğ´ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ğ¹ Ğ¾Ğ´Ğ¾Ğ¼ĞµÑ‚Ñ€Ğ° Ğ½Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾"""
    if not validate_number(message.text):
        await message.answer("âŒ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾!")
        return
    
    await state.update_data(odo_start=float(message.text))
    await message.answer("â›½ ĞÑÑ‚Ğ°Ñ‚Ğ¾Ğº Ñ‚Ğ¾Ğ¿Ğ»Ğ¸Ğ²Ğ° Ğ¿Ñ€Ğ¸ Ğ²Ñ‹ĞµĞ·Ğ´Ğµ:")
    await state.set_state(WaybillStates.fuel_start)

@router.message(WaybillStates.fuel_start)
async def fuel_start_input(message: Message, state: FSMContext):
    """Ğ’Ğ²Ğ¾Ğ´ Ğ¾ÑÑ‚Ğ°Ñ‚ĞºĞ° Ñ‚Ğ¾Ğ¿Ğ»Ğ¸Ğ²Ğ° Ğ½Ğ° Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾"""
    if not validate_number(message.text):
        await message.answer("âŒ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾!")
        return
    
    await state.update_data(fuel_start=float(message.text))
    await message.answer("ğŸ•“ Ğ’Ñ€ĞµĞ¼Ñ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ñ Ñ Ğ»Ğ¸Ğ½Ğ¸Ğ¸ (Ğ§Ğ§:ĞœĞœ):")
    await state.set_state(WaybillStates.end_time)

@router.message(WaybillStates.end_time)
async def end_time_input(message: Message, state: FSMContext):
    """Ğ’Ğ²Ğ¾Ğ´ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ"""
    if not validate_time(message.text):
        await message.answer("âŒ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚! Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ñ€ĞµĞ¼Ñ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ Ğ§Ğ§:ĞœĞœ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: <code>17:30</code>)")
        return
    
    data = await state.get_data()
    hours = calculate_hours(data["start_time"], message.text)
    await state.update_data(end_time=message.text, hours=hours)
    
    await message.answer(
        f"â± Ğ’ÑĞµĞ³Ğ¾ Ğ² Ğ½Ğ°Ñ€ÑĞ´Ğµ: <b>{hours} Ñ‡</b>\n\n"
        "ğŸš— ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ñ Ğ¾Ğ´Ğ¾Ğ¼ĞµÑ‚Ñ€Ğ° Ğ½Ğ° ĞºĞ¾Ğ½ĞµÑ† Ğ´Ğ½Ñ:"
    )
    await state.set_state(WaybillStates.odo_end)

@router.message(WaybillStates.odo_end)
async def odo_end_input(message: Message, state: FSMContext):
    """Ğ’Ğ²Ğ¾Ğ´ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ğ¹ Ğ¾Ğ´Ğ¾Ğ¼ĞµÑ‚Ñ€Ğ° Ğ½Ğ° ĞºĞ¾Ğ½ĞµÑ†"""
    if not validate_number(message.text):
        await message.answer("âŒ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾!")
        return
    
    data = await state.get_data()
    odo_end = float(message.text)
    distance = odo_end - data["odo_start"]
    
    if distance < 0:
        await message.answer("âŒ ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¸Ñ Ğ¾Ğ´Ğ¾Ğ¼ĞµÑ‚Ñ€Ğ° Ğ½Ğµ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¼ĞµĞ½ÑŒÑˆĞµ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ñ…!")
        return
    
    await state.update_data(odo_end=odo_end, distance=distance)
    await message.answer(
        f"ğŸ“ ĞŸÑ€Ğ¾Ğ±ĞµĞ³ Ğ·Ğ° Ğ´ĞµĞ½ÑŒ: <b>{distance:.0f} ĞºĞ¼</b>\n\n"
        "âš ï¸ ĞŸĞµÑ€ĞµÑ€Ğ°ÑÑ…Ğ¾Ğ´ Ñ‚Ğ¾Ğ¿Ğ»Ğ¸Ğ²Ğ° (Ğ») Ğ¸Ğ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ:",
        reply_markup=get_skip_keyboard()
    )
    await state.set_state(WaybillStates.overuse)

@router.message(WaybillStates.overuse)
async def overuse_input(message: Message, state: FSMContext):
    """Ğ’Ğ²Ğ¾Ğ´ Ğ¿ĞµÑ€ĞµÑ€Ğ°ÑÑ…Ğ¾Ğ´Ğ°"""
    if message.text == "â­ ĞŸÑ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ":
        await state.update_data(overuse=0)
    elif not validate_number(message.text):
        await message.answer("âŒ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾ Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ 'ĞŸÑ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ'!")
        return
    else:
        await state.update_data(overuse=float(message.text))
    
    await message.answer(
        "ğŸ’° Ğ­ĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ñ Ñ‚Ğ¾Ğ¿Ğ»Ğ¸Ğ²Ğ° (Ğ») Ğ¸Ğ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ:",
        reply_markup=get_skip_keyboard()
    )
    await state.set_state(WaybillStates.economy)

@router.message(WaybillStates.economy)
async def economy_input(message: Message, state: FSMContext):
    """Ğ’Ğ²Ğ¾Ğ´ ÑĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ğ¸ Ğ¸ Ñ€Ğ°ÑÑ‡ĞµÑ‚ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²"""
    if message.text == "â­ ĞŸÑ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ":
        economy = 0
    elif not validate_number(message.text):
        await message.answer("âŒ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾ Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ 'ĞŸÑ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ'!")
        return
    else:
        economy = float(message.text)
    
    await state.update_data(economy=economy)
    data = await state.get_data()
    
    # Ğ Ğ°ÑÑ‡ĞµÑ‚Ñ‹
    fuel_norm = data['distance'] * data['fuel_rate']
    fuel_actual = fuel_norm - data['economy'] + data['overuse']
    fuel_end = data['fuel_start'] - fuel_actual
    
    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ² Ğ‘Ğ”
    waybill_data = {
        'vehicle_id': data['vehicle_id'],
        'user_id': data['user_id'],
        'start_time': data['start_time'],
        'end_time': data['end_time'],
        'hours': data['hours'],
        'odo_start': data['odo_start'],
        'odo_end': data['odo_end'],
        'distance': data['distance'],
        'fuel_start': data['fuel_start'],
        'fuel_end': fuel_end,
        'fuel_norm': fuel_norm,
        'fuel_actual': fuel_actual,
        'overuse': data['overuse'],
        'economy': data['economy'],
        'fuel_rate': data['fuel_rate']
    }
    
    waybill_id = Database.save_waybill(waybill_data)
    
    if waybill_id:
        # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ°
        report = f"""
âœ… <b>ĞŸĞ£Ğ¢Ğ•Ğ’ĞĞ™ Ğ›Ğ˜Ğ¡Ğ¢ #{waybill_id} Ğ¡ĞĞ¥Ğ ĞĞĞ•Ğ</b>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸš— <b>ĞĞ²Ñ‚Ğ¾Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒ:</b> {data['vehicle_number']}
ğŸ“… <b>Ğ”Ğ°Ñ‚Ğ°:</b> {datetime.now().strftime('%Y-%m-%d')}

<b>ğŸ“‹ Ğ’Ğ’Ğ•Ğ”Ğ•ĞĞĞ«Ğ• Ğ”ĞĞĞĞ«Ğ•:</b>
ğŸ•’ Ğ’Ñ€ĞµĞ¼Ñ Ğ²Ñ‹ĞµĞ·Ğ´Ğ°: {data['start_time']}
ğŸ•“ Ğ’Ñ€ĞµĞ¼Ñ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ñ: {data['end_time']}
â± Ğ’ÑĞµĞ³Ğ¾ Ğ² Ğ½Ğ°Ñ€ÑĞ´Ğµ: {data['hours']} Ñ‡
ğŸ›£ ĞĞ´Ğ¾Ğ¼ĞµÑ‚Ñ€ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾: {data['odo_start']:.0f} ĞºĞ¼
ğŸ›£ ĞĞ´Ğ¾Ğ¼ĞµÑ‚Ñ€ ĞºĞ¾Ğ½ĞµÑ†: {data['odo_end']:.0f} ĞºĞ¼
â›½ Ğ¢Ğ¾Ğ¿Ğ»Ğ¸Ğ²Ğ¾ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾: {data['fuel_start']:.2f} Ğ»
ğŸ“ˆ ĞŸĞµÑ€ĞµÑ€Ğ°ÑÑ…Ğ¾Ğ´: {data['overuse']:.2f} Ğ»
ğŸ“‰ Ğ­ĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ñ: {data['economy']:.2f} Ğ»

<b>ğŸ“Š Ğ ĞĞ¡Ğ§Ğ•Ğ¢ĞĞ«Ğ• ĞŸĞĞšĞĞ—ĞĞ¢Ğ•Ğ›Ğ˜:</b>
ğŸ“ ĞŸÑ€Ğ¾Ğ±ĞµĞ³ Ğ·Ğ° Ğ´ĞµĞ½ÑŒ: {data['distance']:.0f} ĞºĞ¼
ğŸ“ˆ Ğ Ğ°ÑÑ…Ğ¾Ğ´ Ğ¿Ğ¾ Ğ½Ğ¾Ñ€Ğ¼Ğµ: {fuel_norm:.2f} Ğ»
ğŸ“‰ Ğ¤Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ñ€Ğ°ÑÑ…Ğ¾Ğ´: {fuel_actual:.2f} Ğ»
â›½ ĞÑÑ‚Ğ°Ñ‚Ğ¾Ğº Ñ‚Ğ¾Ğ¿Ğ»Ğ¸Ğ²Ğ°: {fuel_end:.2f} Ğ»
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹!
        """
        
        await message.answer(report, reply_markup=get_main_keyboard())
        logger.info(f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {data['user_id']} ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ» Ğ¿ÑƒÑ‚ĞµĞ²Ğ¾Ğ¹ Ğ»Ğ¸ÑÑ‚ #{waybill_id}")
    else:
        await message.answer(
            "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ĞµÑ‰Ğµ Ñ€Ğ°Ğ·.",
            reply_markup=get_main_keyboard()
        )
        logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ¿ÑƒÑ‚ĞµĞ²Ğ¾Ğ³Ğ¾ Ğ»Ğ¸ÑÑ‚Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼ {data['user_id']}")
    
    await state.clear()

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸš€ Ğ—ĞĞŸĞ£Ğ¡Ğš Ğ‘ĞĞ¢Ğ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async def main():
    """ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ±Ğ¾Ñ‚Ğ°"""
    logger.info("ğŸš€ Ğ‘Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ...")
    
    # Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
    init_database()
    
    # Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ²ĞµĞ±Ñ…ÑƒĞºĞ° (ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ)
    await bot.delete_webhook(drop_pending_updates=True)
    
    # Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿Ğ¾Ğ»Ğ»Ğ¸Ğ½Ğ³Ğ°
    logger.info("âœ… Ğ‘Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ Ğ¸ Ğ³Ğ¾Ñ‚Ğ¾Ğ² Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ!")
    await dp.start_polling(bot)

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("ğŸ›‘ Ğ‘Ğ¾Ñ‚ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼")
    except Exception as e:
        logger.error(f"ğŸ’¥ ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: {e}")
